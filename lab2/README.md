# Распределенные системы хранения данных

## Лабораторная работа №2

### Этап 1. Инициализация кластера БД

- Директория кластера: $HOME/ckl25
- Кодировка: ISO_8859_5
- Локаль: русская
- Параметры инициализации задать через переменные окружения

`~/.profile`
```
export PGHOST=pg106
export PGUSERNAME=postgres1
export PGDATA=$HOME/ckl25
export PGENCODING=ISO8859-5
export PGLOCALE=ru_RU.ISO8859-5
export PGCLIENTENCODING=$PGENCODING
```

### Этап 2. Конфигурация и запуск сервера БД

- Способы подключения:
    1. Unix-domain сокет в режиме peer;
    2. сокет TCP/IP, только localhost
- Номер порта: 9853
- Способ аутентификации TCP/IP клиентов: по имени пользователя
- Остальные способы подключений запретить.

`$PGDATA/postgresql.conf`
```
listen_addresses='localhost'
port = 9853
```
`$PGDATA/pg_hba.conf.conf`
```
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             all                                     peer
# IPv4 local connections:
host    all             all             127.0.0.1/32            ident
# IPv6 local connections:
host    all             all             ::1/128                 ident
```

- Настроить следующие параметры сервера БД:
    - max_connections
    - shared_buffers
    - temp_buffers
    - work_mem
    - checkpoint_timeout
    - effective_cache_size
    - fsync
    - commit_delay
    
    Параметры должны быть подобраны в соответствии со сценарием OLTP:
    - 200 одновременных пользователей
    - 2 сессий на каждого
    - каждая сессия инициирует до 7 транзакций на запись размером 24КБ
    - обеспечить максимальную производительность

OLTP (Online Transaction Processing) — это обработка транзакций в реальном времени. Это тип рабочей нагрузки баз данных, при котором система должна быстро и эффективно обрабатывать много частых, небольших операций, чаще всего записей, обновлений и чтений.

```
max_connections = 500
# 400 активных сессий + запас для админа, фоновых процессов, очереди.

shared_buffers = 4GB
# 25% RAM

temp_buffers = 64MB

work_mem = 4MB 

checkpoint_timeout = 15min
# Чем реже, тем меньше нагрузка на диск, но дольше recovery после сбоя. OLTP часто требует баланса.


effective_cache_size = 12GB 
# 75% RAM

fsync = off 
# Запись на диск при каждом коммите отключена ради производительности
```


- Директория WAL файлов: $PGDATA/pg_wal
- Формат лог-файлов: .csv
- Уровень сообщений лога: ERROR
- Дополнительно логировать: завершение сессий и продолжительность выполнения команд

```
log_destination = 'csvlog'
logging_collector = on
log_min_messages = error
log_disconnections = on
log_duration = on
```




### Этап 3. Дополнительные табличные пространства и наполнение базы

- Создать новое табличное пространство для индексов: $HOME/zbn52
- На основе template1 создать новую базу: bigwhitedata
- Создать новую роль, предоставить необходимые права, разрешить подключение к базе.
- От имени новой роли (не администратора) произвести наполнение ВСЕХ созданных баз тестовыми наборами данных. ВСЕ табличные пространства должны использоваться по назначению.
-Вывести список всех табличных пространств кластера и содержащиеся в них объекты.